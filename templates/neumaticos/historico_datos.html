{% extends "base.html" %}

{% block title %}Histórico de Datos{% endblock %}

{% block content %}
<div class="panel-header panel-header-sm">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <h2 class="text-white mb-4" style="font-weight: 700;">Histórico de Averías y Estado de Cauchos</h2>
            </div>
        </div>
    </div>
</div>

<div class="content d-flex justify-content-center">
    <div class="container card shadow-lg rounded p-5" style="background-color: #f4f5f7; max-width: 900px;">

        <!-- Filtro para seleccionar el usuario (solo visible para el admin) -->
        {% if request.user.is_superuser %}
        <form method="GET" id="userFilterForm" class="mb-4">
            <label for="usuario" class="form-label">Selecciona un usuario para ver su historial:</label>
            <select name="usuario_id" id="usuario" class="form-control" onchange="document.getElementById('userFilterForm').submit();">
                <option value="{{ request.user.id }}">{{ request.user.get_full_name }} ({{ request.user.email }})</option>
                {% for usuario in usuarios %}
                    <option value="{{ usuario.id }}" {% if selected_user.id == usuario.id %}selected{% endif %}>
                        {{ usuario.get_full_name }} ({{ usuario.email }})
                    </option>
                {% endfor %}
            </select>
        </form>
        {% endif %}
        
        <!-- Gráfico Histórico de Averías -->
        <div class="card mb-4">
            <div class="card-body">
                <canvas id="historicoChart"></canvas>
            </div>
        </div>

        <!-- Nueva Gráfica Relación de Cauchos (Tres barras por mes) -->
        <div class="card mb-4">
            <div class="card-body">
                <h4>Relación de cauchos operativos, renovables, desperdicio (Últimos 6 meses)</h4>
                <canvas id="cauchosMesChart"></canvas>
            </div>
        </div>

        <!-- Conteo de Averías -->
        <h4 class="mt-5">Conteo de Averías</h4>
        <ul class="list-group">
            {% for averia, count in averias_counter.items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ averia }}
                    <span class="badge bg-primary rounded-pill">{{ count }}</span>
                </li>
            {% endfor %}
        </ul>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx1 = document.getElementById('historicoChart').getContext('2d');
    const labels = {{ labels|safe }};
    const dataBarras = {{ data_barras|safe }};
    const dataLinea = {{ porcentaje_acumulado|safe }};

    const chart1 = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Averías (%)',
                    data: dataBarras,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'y',
                },
                {
                    type: 'line',
                    label: 'Porcentaje Acumulado (%)',
                    data: dataLinea,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: false,
                    yAxisID: 'y1',
                    tension: 0.3,
                    pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    ticks: {
                        beginAtZero: true,
                        callback: function(value) {
                            return value + '%';  
                        },
                        max: 100  
                    },
                    title: {
                        display: true,
                        text: 'Porcentaje de Averías'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    ticks: {
                        beginAtZero: true,
                        callback: function(value) {
                            return value + '%';  
                        },
                        max: 100  
                    },
                    grid: {
                        drawOnChartArea: false
                    },
                    title: {
                        display: true,
                        text: 'Porcentaje Acumulado'
                    }
                }
            }
        }
    });

    // Nueva gráfica de relación de cauchos por mes
    const ctx2 = document.getElementById('cauchosMesChart').getContext('2d');
    const mesesLabels = {{ meses_labels|safe }};
    const operativosMesData = {{ operativos_mes|safe }};
    const renovablesMesData = {{ renovables_mes|safe }};
    const desperdicioMesData = {{ desperdicio_mes|safe }};

    const chart2 = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: mesesLabels,
            datasets: [
                {
                    label: 'Operativos',
                    data: operativosMesData,
                    backgroundColor: '#2ecc71',
                    borderColor: '#27ae60',
                    borderWidth: 1
                },
                {
                    label: 'Renovables',
                    data: renovablesMesData,
                    backgroundColor: '#f1c40f',
                    borderColor: '#f39c12',
                    borderWidth: 1
                },
                {
                    label: 'Desperdicio',
                    data: desperdicioMesData,
                    backgroundColor: '#e74c3c',
                    borderColor: '#c0392b',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

{% endblock %}
